<!doctype html>
<html data-n-head-ssr lang="en" amp data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D,%22amp%22:%7B%22ssr%22:true%7D%7D">
  <head>
    <title>A complete ML Pipeline study case&amp#58; Face and Emotion Recognition - Gioele Crispo</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="robots" content="index,follow"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="og:type" property="og:type" content="website"><meta data-n-head="ssr" data-hid="og:site_name" property="og:site_name" content="Gioele Crispo"><meta data-n-head="ssr" data-hid="og:title" property="og:title" content="A complete ML Pipeline study case&amp;#58; Face and Emotion Recognition - Gioele Crispo"><meta data-n-head="ssr" data-hid="description" name="description" content="A journey through the phases of data exploration and training of a CNN model from scratch. A particular focus on optimization for production with Optuna and ONNX is carried out."><meta data-n-head="ssr" data-hid="og:description" name="og:description" content="A journey through the phases of data exploration and training of a CNN model from scratch. A particular focus on optimization for production with Optuna and ONNX is carried out."><meta data-n-head="ssr" data-hid="og:url" property="og:url" content="https://gioelecrispo.github.io/blog/a-complete-ml-pipeline-study-case-face-and-emotion-recognition/"><meta data-n-head="ssr" data-hid="og:image" property="og:image" content="/_nuxt/img/e47f985.jpg"><meta data-n-head="ssr" data-hid="twitter:card" property="twitter:card" content="summary_large_image"><meta data-n-head="ssr" data-hid="twitter:title" property="twitter:title" content="A complete ML Pipeline study case&amp;#58; Face and Emotion Recognition - Gioele Crispo"><meta data-n-head="ssr" data-hid="twitter:description" name="twitter:description" content="A journey through the phases of data exploration and training of a CNN model from scratch. A particular focus on optimization for production with Optuna and ONNX is carried out."><meta data-n-head="ssr" data-hid="twitter:image" property="twitter:image" content="/_nuxt/img/e47f985.jpg"><meta data-n-head="ssr" data-hid="article:published_time" property="article:published_time" content="2021-12-27T21:51:10.516Z"><meta data-n-head="ssr" data-hid="article:modified_time" property="article:modified_time" content="2021-12-27T21:51:10.516Z"><meta data-n-head="ssr" data-hid="article:tag" property="article:tag" content="computer-vision,mlops"><meta data-n-head="ssr" data-hid="twitter:label1" property="twitter:label1" content="Written by"><meta data-n-head="ssr" data-hid="twitter:data1" property="twitter:data1" content="Gioele Crispo, Stefania Avallone"><meta data-n-head="ssr" data-hid="twitter:label2" property="twitter:label2" content="Filed under"><meta data-n-head="ssr" data-hid="twitter:data2" property="twitter:data2" content="computer-vision,mlops"><base href="/"><link data-n-head="ssr" rel="icon" type="image/png" href="/favicon.ico"><link data-n-head="ssr" rel="canonical" href="https://gioelecrispo.github.io/blog/a-complete-ml-pipeline-study-case-face-and-emotion-recognition/"><style data-n-head="vuetify" type="text/css" id="vuetify-theme-stylesheet" nonce="undefined">:root{--v-anchor-base:#2196f3;--v-primary-base:#2196f3;--v-primary-lighten5:#d4ffff;--v-primary-lighten4:#b5ffff;--v-primary-lighten3:#95e8ff;--v-primary-lighten2:#75ccff;--v-primary-lighten1:#51b0ff;--v-primary-darken1:#007cd6;--v-primary-darken2:#0064ba;--v-primary-darken3:#004d9f;--v-primary-darken4:#003784;--v-secondary-base:#e91e63;--v-secondary-lighten5:#ffc0e7;--v-secondary-lighten4:#ffa3cb;--v-secondary-lighten3:#ff85b0;--v-secondary-lighten2:#ff6795;--v-secondary-lighten1:#ff467c;--v-secondary-darken1:#c9004b;--v-secondary-darken2:#aa0035;--v-secondary-darken3:#8b0021;--v-secondary-darken4:#6c000a;--v-accent-base:#ffb510;--v-accent-lighten5:#ffffad;--v-accent-lighten4:#ffff90;--v-accent-lighten3:#ffff74;--v-accent-lighten2:#ffed57;--v-accent-lighten1:#ffd039;--v-accent-darken1:#df9a00;--v-accent-darken2:#c08000;--v-accent-darken3:#a26700;--v-accent-darken4:#854f00;--v-error-base:#ff5252;--v-error-lighten5:#ffe4d5;--v-error-lighten4:#ffc6b9;--v-error-lighten3:#ffa99e;--v-error-lighten2:#ff8c84;--v-error-lighten1:#ff6f6a;--v-error-darken1:#df323b;--v-error-darken2:#bf0025;--v-error-darken3:#9f0010;--v-error-darken4:#800000;--v-info-base:#2196f3;--v-info-lighten5:#d4ffff;--v-info-lighten4:#b5ffff;--v-info-lighten3:#95e8ff;--v-info-lighten2:#75ccff;--v-info-lighten1:#51b0ff;--v-info-darken1:#007cd6;--v-info-darken2:#0064ba;--v-info-darken3:#004d9f;--v-info-darken4:#003784;--v-success-base:#4caf50;--v-success-lighten5:#dcffd6;--v-success-lighten4:#beffba;--v-success-lighten3:#a2ff9e;--v-success-lighten2:#85e783;--v-success-lighten1:#69cb69;--v-success-darken1:#2d9437;--v-success-darken2:#00791e;--v-success-darken3:#006000;--v-success-darken4:#004700;--v-warning-base:#ffc107;--v-warning-lighten5:#ffffae;--v-warning-lighten4:#ffff91;--v-warning-lighten3:#ffff74;--v-warning-lighten2:#fff956;--v-warning-lighten1:#ffdd37;--v-warning-darken1:#e0a600;--v-warning-darken2:#c18c00;--v-warning-darken3:#a27300;--v-warning-darken4:#855a00;--v-sectionPrimary-base:#ffffff;--v-sectionPrimary-lighten5:#ffffff;--v-sectionPrimary-lighten4:#ffffff;--v-sectionPrimary-lighten3:#ffffff;--v-sectionPrimary-lighten2:#ffffff;--v-sectionPrimary-lighten1:#ffffff;--v-sectionPrimary-darken1:#e2e2e2;--v-sectionPrimary-darken2:#c6c6c6;--v-sectionPrimary-darken3:#ababab;--v-sectionPrimary-darken4:#919191;--v-sectionSecondary-base:#efefef;--v-sectionSecondary-lighten5:#ffffff;--v-sectionSecondary-lighten4:#ffffff;--v-sectionSecondary-lighten3:#ffffff;--v-sectionSecondary-lighten2:#ffffff;--v-sectionSecondary-lighten1:#ffffff;--v-sectionSecondary-darken1:#d3d3d3;--v-sectionSecondary-darken2:#b7b7b7;--v-sectionSecondary-darken3:#9c9c9c;--v-sectionSecondary-darken4:#828282}.v-application a{color:var(--v-anchor-base)}.v-application .primary{background-color:var(--v-primary-base)!important;border-color:var(--v-primary-base)!important}.v-application .primary--text{color:var(--v-primary-base)!important;caret-color:var(--v-primary-base)!important}.v-application .primary.lighten-5{background-color:var(--v-primary-lighten5)!important;border-color:var(--v-primary-lighten5)!important}.v-application .primary--text.text--lighten-5{color:var(--v-primary-lighten5)!important;caret-color:var(--v-primary-lighten5)!important}.v-application .primary.lighten-4{background-color:var(--v-primary-lighten4)!important;border-color:var(--v-primary-lighten4)!important}.v-application .primary--text.text--lighten-4{color:var(--v-primary-lighten4)!important;caret-color:var(--v-primary-lighten4)!important}.v-application .primary.lighten-3{background-color:var(--v-primary-lighten3)!important;border-color:var(--v-primary-lighten3)!important}.v-application .primary--text.text--lighten-3{color:var(--v-primary-lighten3)!important;caret-color:var(--v-primary-lighten3)!important}.v-application .primary.lighten-2{background-color:var(--v-primary-lighten2)!important;border-color:var(--v-primary-lighten2)!important}.v-application .primary--text.text--lighten-2{color:var(--v-primary-lighten2)!important;caret-color:var(--v-primary-lighten2)!important}.v-application .primary.lighten-1{background-color:var(--v-primary-lighten1)!important;border-color:var(--v-primary-lighten1)!important}.v-application .primary--text.text--lighten-1{color:var(--v-primary-lighten1)!important;caret-color:var(--v-primary-lighten1)!important}.v-application .primary.darken-1{background-color:var(--v-primary-darken1)!important;border-color:var(--v-primary-darken1)!important}.v-application .primary--text.text--darken-1{color:var(--v-primary-darken1)!important;caret-color:var(--v-primary-darken1)!important}.v-application .primary.darken-2{background-color:var(--v-primary-darken2)!important;border-color:var(--v-primary-darken2)!important}.v-application .primary--text.text--darken-2{color:var(--v-primary-darken2)!important;caret-color:var(--v-primary-darken2)!important}.v-application .primary.darken-3{background-color:var(--v-primary-darken3)!important;border-color:var(--v-primary-darken3)!important}.v-application .primary--text.text--darken-3{color:var(--v-primary-darken3)!important;caret-color:var(--v-primary-darken3)!important}.v-application .primary.darken-4{background-color:var(--v-primary-darken4)!important;border-color:var(--v-primary-darken4)!important}.v-application .primary--text.text--darken-4{color:var(--v-primary-darken4)!important;caret-color:var(--v-primary-darken4)!important}.v-application .secondary{background-color:var(--v-secondary-base)!important;border-color:var(--v-secondary-base)!important}.v-application .secondary--text{color:var(--v-secondary-base)!important;caret-color:var(--v-secondary-base)!important}.v-application .secondary.lighten-5{background-color:var(--v-secondary-lighten5)!important;border-color:var(--v-secondary-lighten5)!important}.v-application .secondary--text.text--lighten-5{color:var(--v-secondary-lighten5)!important;caret-color:var(--v-secondary-lighten5)!important}.v-application .secondary.lighten-4{background-color:var(--v-secondary-lighten4)!important;border-color:var(--v-secondary-lighten4)!important}.v-application .secondary--text.text--lighten-4{color:var(--v-secondary-lighten4)!important;caret-color:var(--v-secondary-lighten4)!important}.v-application .secondary.lighten-3{background-color:var(--v-secondary-lighten3)!important;border-color:var(--v-secondary-lighten3)!important}.v-application .secondary--text.text--lighten-3{color:var(--v-secondary-lighten3)!important;caret-color:var(--v-secondary-lighten3)!important}.v-application .secondary.lighten-2{background-color:var(--v-secondary-lighten2)!important;border-color:var(--v-secondary-lighten2)!important}.v-application .secondary--text.text--lighten-2{color:var(--v-secondary-lighten2)!important;caret-color:var(--v-secondary-lighten2)!important}.v-application .secondary.lighten-1{background-color:var(--v-secondary-lighten1)!important;border-color:var(--v-secondary-lighten1)!important}.v-application .secondary--text.text--lighten-1{color:var(--v-secondary-lighten1)!important;caret-color:var(--v-secondary-lighten1)!important}.v-application .secondary.darken-1{background-color:var(--v-secondary-darken1)!important;border-color:var(--v-secondary-darken1)!important}.v-application .secondary--text.text--darken-1{color:var(--v-secondary-darken1)!important;caret-color:var(--v-secondary-darken1)!important}.v-application .secondary.darken-2{background-color:var(--v-secondary-darken2)!important;border-color:var(--v-secondary-darken2)!important}.v-application .secondary--text.text--darken-2{color:var(--v-secondary-darken2)!important;caret-color:var(--v-secondary-darken2)!important}.v-application .secondary.darken-3{background-color:var(--v-secondary-darken3)!important;border-color:var(--v-secondary-darken3)!important}.v-application .secondary--text.text--darken-3{color:var(--v-secondary-darken3)!important;caret-color:var(--v-secondary-darken3)!important}.v-application .secondary.darken-4{background-color:var(--v-secondary-darken4)!important;border-color:var(--v-secondary-darken4)!important}.v-application .secondary--text.text--darken-4{color:var(--v-secondary-darken4)!important;caret-color:var(--v-secondary-darken4)!important}.v-application .accent{background-color:var(--v-accent-base)!important;border-color:var(--v-accent-base)!important}.v-application .accent--text{color:var(--v-accent-base)!important;caret-color:var(--v-accent-base)!important}.v-application .accent.lighten-5{background-color:var(--v-accent-lighten5)!important;border-color:var(--v-accent-lighten5)!important}.v-application .accent--text.text--lighten-5{color:var(--v-accent-lighten5)!important;caret-color:var(--v-accent-lighten5)!important}.v-application .accent.lighten-4{background-color:var(--v-accent-lighten4)!important;border-color:var(--v-accent-lighten4)!important}.v-application .accent--text.text--lighten-4{color:var(--v-accent-lighten4)!important;caret-color:var(--v-accent-lighten4)!important}.v-application .accent.lighten-3{background-color:var(--v-accent-lighten3)!important;border-color:var(--v-accent-lighten3)!important}.v-application .accent--text.text--lighten-3{color:var(--v-accent-lighten3)!important;caret-color:var(--v-accent-lighten3)!important}.v-application .accent.lighten-2{background-color:var(--v-accent-lighten2)!important;border-color:var(--v-accent-lighten2)!important}.v-application .accent--text.text--lighten-2{color:var(--v-accent-lighten2)!important;caret-color:var(--v-accent-lighten2)!important}.v-application .accent.lighten-1{background-color:var(--v-accent-lighten1)!important;border-color:var(--v-accent-lighten1)!important}.v-application .accent--text.text--lighten-1{color:var(--v-accent-lighten1)!important;caret-color:var(--v-accent-lighten1)!important}.v-application .accent.darken-1{background-color:var(--v-accent-darken1)!important;border-color:var(--v-accent-darken1)!important}.v-application .accent--text.text--darken-1{color:var(--v-accent-darken1)!important;caret-color:var(--v-accent-darken1)!important}.v-application .accent.darken-2{background-color:var(--v-accent-darken2)!important;border-color:var(--v-accent-darken2)!important}.v-application .accent--text.text--darken-2{color:var(--v-accent-darken2)!important;caret-color:var(--v-accent-darken2)!important}.v-application .accent.darken-3{background-color:var(--v-accent-darken3)!important;border-color:var(--v-accent-darken3)!important}.v-application .accent--text.text--darken-3{color:var(--v-accent-darken3)!important;caret-color:var(--v-accent-darken3)!important}.v-application .accent.darken-4{background-color:var(--v-accent-darken4)!important;border-color:var(--v-accent-darken4)!important}.v-application .accent--text.text--darken-4{color:var(--v-accent-darken4)!important;caret-color:var(--v-accent-darken4)!important}.v-application .error{background-color:var(--v-error-base)!important;border-color:var(--v-error-base)!important}.v-application .error--text{color:var(--v-error-base)!important;caret-color:var(--v-error-base)!important}.v-application .error.lighten-5{background-color:var(--v-error-lighten5)!important;border-color:var(--v-error-lighten5)!important}.v-application .error--text.text--lighten-5{color:var(--v-error-lighten5)!important;caret-color:var(--v-error-lighten5)!important}.v-application .error.lighten-4{background-color:var(--v-error-lighten4)!important;border-color:var(--v-error-lighten4)!important}.v-application .error--text.text--lighten-4{color:var(--v-error-lighten4)!important;caret-color:var(--v-error-lighten4)!important}.v-application .error.lighten-3{background-color:var(--v-error-lighten3)!important;border-color:var(--v-error-lighten3)!important}.v-application .error--text.text--lighten-3{color:var(--v-error-lighten3)!important;caret-color:var(--v-error-lighten3)!important}.v-application .error.lighten-2{background-color:var(--v-error-lighten2)!important;border-color:var(--v-error-lighten2)!important}.v-application .error--text.text--lighten-2{color:var(--v-error-lighten2)!important;caret-color:var(--v-error-lighten2)!important}.v-application .error.lighten-1{background-color:var(--v-error-lighten1)!important;border-color:var(--v-error-lighten1)!important}.v-application .error--text.text--lighten-1{color:var(--v-error-lighten1)!important;caret-color:var(--v-error-lighten1)!important}.v-application .error.darken-1{background-color:var(--v-error-darken1)!important;border-color:var(--v-error-darken1)!important}.v-application .error--text.text--darken-1{color:var(--v-error-darken1)!important;caret-color:var(--v-error-darken1)!important}.v-application .error.darken-2{background-color:var(--v-error-darken2)!important;border-color:var(--v-error-darken2)!important}.v-application .error--text.text--darken-2{color:var(--v-error-darken2)!important;caret-color:var(--v-error-darken2)!important}.v-application .error.darken-3{background-color:var(--v-error-darken3)!important;border-color:var(--v-error-darken3)!important}.v-application .error--text.text--darken-3{color:var(--v-error-darken3)!important;caret-color:var(--v-error-darken3)!important}.v-application .error.darken-4{background-color:var(--v-error-darken4)!important;border-color:var(--v-error-darken4)!important}.v-application .error--text.text--darken-4{color:var(--v-error-darken4)!important;caret-color:var(--v-error-darken4)!important}.v-application .info{background-color:var(--v-info-base)!important;border-color:var(--v-info-base)!important}.v-application .info--text{color:var(--v-info-base)!important;caret-color:var(--v-info-base)!important}.v-application .info.lighten-5{background-color:var(--v-info-lighten5)!important;border-color:var(--v-info-lighten5)!important}.v-application .info--text.text--lighten-5{color:var(--v-info-lighten5)!important;caret-color:var(--v-info-lighten5)!important}.v-application .info.lighten-4{background-color:var(--v-info-lighten4)!important;border-color:var(--v-info-lighten4)!important}.v-application .info--text.text--lighten-4{color:var(--v-info-lighten4)!important;caret-color:var(--v-info-lighten4)!important}.v-application .info.lighten-3{background-color:var(--v-info-lighten3)!important;border-color:var(--v-info-lighten3)!important}.v-application .info--text.text--lighten-3{color:var(--v-info-lighten3)!important;caret-color:var(--v-info-lighten3)!important}.v-application .info.lighten-2{background-color:var(--v-info-lighten2)!important;border-color:var(--v-info-lighten2)!important}.v-application .info--text.text--lighten-2{color:var(--v-info-lighten2)!important;caret-color:var(--v-info-lighten2)!important}.v-application .info.lighten-1{background-color:var(--v-info-lighten1)!important;border-color:var(--v-info-lighten1)!important}.v-application .info--text.text--lighten-1{color:var(--v-info-lighten1)!important;caret-color:var(--v-info-lighten1)!important}.v-application .info.darken-1{background-color:var(--v-info-darken1)!important;border-color:var(--v-info-darken1)!important}.v-application .info--text.text--darken-1{color:var(--v-info-darken1)!important;caret-color:var(--v-info-darken1)!important}.v-application .info.darken-2{background-color:var(--v-info-darken2)!important;border-color:var(--v-info-darken2)!important}.v-application .info--text.text--darken-2{color:var(--v-info-darken2)!important;caret-color:var(--v-info-darken2)!important}.v-application .info.darken-3{background-color:var(--v-info-darken3)!important;border-color:var(--v-info-darken3)!important}.v-application .info--text.text--darken-3{color:var(--v-info-darken3)!important;caret-color:var(--v-info-darken3)!important}.v-application .info.darken-4{background-color:var(--v-info-darken4)!important;border-color:var(--v-info-darken4)!important}.v-application .info--text.text--darken-4{color:var(--v-info-darken4)!important;caret-color:var(--v-info-darken4)!important}.v-application .success{background-color:var(--v-success-base)!important;border-color:var(--v-success-base)!important}.v-application .success--text{color:var(--v-success-base)!important;caret-color:var(--v-success-base)!important}.v-application .success.lighten-5{background-color:var(--v-success-lighten5)!important;border-color:var(--v-success-lighten5)!important}.v-application .success--text.text--lighten-5{color:var(--v-success-lighten5)!important;caret-color:var(--v-success-lighten5)!important}.v-application .success.lighten-4{background-color:var(--v-success-lighten4)!important;border-color:var(--v-success-lighten4)!important}.v-application .success--text.text--lighten-4{color:var(--v-success-lighten4)!important;caret-color:var(--v-success-lighten4)!important}.v-application .success.lighten-3{background-color:var(--v-success-lighten3)!important;border-color:var(--v-success-lighten3)!important}.v-application .success--text.text--lighten-3{color:var(--v-success-lighten3)!important;caret-color:var(--v-success-lighten3)!important}.v-application .success.lighten-2{background-color:var(--v-success-lighten2)!important;border-color:var(--v-success-lighten2)!important}.v-application .success--text.text--lighten-2{color:var(--v-success-lighten2)!important;caret-color:var(--v-success-lighten2)!important}.v-application .success.lighten-1{background-color:var(--v-success-lighten1)!important;border-color:var(--v-success-lighten1)!important}.v-application .success--text.text--lighten-1{color:var(--v-success-lighten1)!important;caret-color:var(--v-success-lighten1)!important}.v-application .success.darken-1{background-color:var(--v-success-darken1)!important;border-color:var(--v-success-darken1)!important}.v-application .success--text.text--darken-1{color:var(--v-success-darken1)!important;caret-color:var(--v-success-darken1)!important}.v-application .success.darken-2{background-color:var(--v-success-darken2)!important;border-color:var(--v-success-darken2)!important}.v-application .success--text.text--darken-2{color:var(--v-success-darken2)!important;caret-color:var(--v-success-darken2)!important}.v-application .success.darken-3{background-color:var(--v-success-darken3)!important;border-color:var(--v-success-darken3)!important}.v-application .success--text.text--darken-3{color:var(--v-success-darken3)!important;caret-color:var(--v-success-darken3)!important}.v-application .success.darken-4{background-color:var(--v-success-darken4)!important;border-color:var(--v-success-darken4)!important}.v-application .success--text.text--darken-4{color:var(--v-success-darken4)!important;caret-color:var(--v-success-darken4)!important}.v-application .warning{background-color:var(--v-warning-base)!important;border-color:var(--v-warning-base)!important}.v-application .warning--text{color:var(--v-warning-base)!important;caret-color:var(--v-warning-base)!important}.v-application .warning.lighten-5{background-color:var(--v-warning-lighten5)!important;border-color:var(--v-warning-lighten5)!important}.v-application .warning--text.text--lighten-5{color:var(--v-warning-lighten5)!important;caret-color:var(--v-warning-lighten5)!important}.v-application .warning.lighten-4{background-color:var(--v-warning-lighten4)!important;border-color:var(--v-warning-lighten4)!important}.v-application .warning--text.text--lighten-4{color:var(--v-warning-lighten4)!important;caret-color:var(--v-warning-lighten4)!important}.v-application .warning.lighten-3{background-color:var(--v-warning-lighten3)!important;border-color:var(--v-warning-lighten3)!important}.v-application .warning--text.text--lighten-3{color:var(--v-warning-lighten3)!important;caret-color:var(--v-warning-lighten3)!important}.v-application .warning.lighten-2{background-color:var(--v-warning-lighten2)!important;border-color:var(--v-warning-lighten2)!important}.v-application .warning--text.text--lighten-2{color:var(--v-warning-lighten2)!important;caret-color:var(--v-warning-lighten2)!important}.v-application .warning.lighten-1{background-color:var(--v-warning-lighten1)!important;border-color:var(--v-warning-lighten1)!important}.v-application .warning--text.text--lighten-1{color:var(--v-warning-lighten1)!important;caret-color:var(--v-warning-lighten1)!important}.v-application .warning.darken-1{background-color:var(--v-warning-darken1)!important;border-color:var(--v-warning-darken1)!important}.v-application .warning--text.text--darken-1{color:var(--v-warning-darken1)!important;caret-color:var(--v-warning-darken1)!important}.v-application .warning.darken-2{background-color:var(--v-warning-darken2)!important;border-color:var(--v-warning-darken2)!important}.v-application .warning--text.text--darken-2{color:var(--v-warning-darken2)!important;caret-color:var(--v-warning-darken2)!important}.v-application .warning.darken-3{background-color:var(--v-warning-darken3)!important;border-color:var(--v-warning-darken3)!important}.v-application .warning--text.text--darken-3{color:var(--v-warning-darken3)!important;caret-color:var(--v-warning-darken3)!important}.v-application .warning.darken-4{background-color:var(--v-warning-darken4)!important;border-color:var(--v-warning-darken4)!important}.v-application .warning--text.text--darken-4{color:var(--v-warning-darken4)!important;caret-color:var(--v-warning-darken4)!important}.v-application .sectionPrimary{background-color:var(--v-sectionPrimary-base)!important;border-color:var(--v-sectionPrimary-base)!important}.v-application .sectionPrimary--text{color:var(--v-sectionPrimary-base)!important;caret-color:var(--v-sectionPrimary-base)!important}.v-application .sectionPrimary.lighten-5{background-color:var(--v-sectionPrimary-lighten5)!important;border-color:var(--v-sectionPrimary-lighten5)!important}.v-application .sectionPrimary--text.text--lighten-5{color:var(--v-sectionPrimary-lighten5)!important;caret-color:var(--v-sectionPrimary-lighten5)!important}.v-application .sectionPrimary.lighten-4{background-color:var(--v-sectionPrimary-lighten4)!important;border-color:var(--v-sectionPrimary-lighten4)!important}.v-application .sectionPrimary--text.text--lighten-4{color:var(--v-sectionPrimary-lighten4)!important;caret-color:var(--v-sectionPrimary-lighten4)!important}.v-application .sectionPrimary.lighten-3{background-color:var(--v-sectionPrimary-lighten3)!important;border-color:var(--v-sectionPrimary-lighten3)!important}.v-application .sectionPrimary--text.text--lighten-3{color:var(--v-sectionPrimary-lighten3)!important;caret-color:var(--v-sectionPrimary-lighten3)!important}.v-application .sectionPrimary.lighten-2{background-color:var(--v-sectionPrimary-lighten2)!important;border-color:var(--v-sectionPrimary-lighten2)!important}.v-application .sectionPrimary--text.text--lighten-2{color:var(--v-sectionPrimary-lighten2)!important;caret-color:var(--v-sectionPrimary-lighten2)!important}.v-application .sectionPrimary.lighten-1{background-color:var(--v-sectionPrimary-lighten1)!important;border-color:var(--v-sectionPrimary-lighten1)!important}.v-application .sectionPrimary--text.text--lighten-1{color:var(--v-sectionPrimary-lighten1)!important;caret-color:var(--v-sectionPrimary-lighten1)!important}.v-application .sectionPrimary.darken-1{background-color:var(--v-sectionPrimary-darken1)!important;border-color:var(--v-sectionPrimary-darken1)!important}.v-application .sectionPrimary--text.text--darken-1{color:var(--v-sectionPrimary-darken1)!important;caret-color:var(--v-sectionPrimary-darken1)!important}.v-application .sectionPrimary.darken-2{background-color:var(--v-sectionPrimary-darken2)!important;border-color:var(--v-sectionPrimary-darken2)!important}.v-application .sectionPrimary--text.text--darken-2{color:var(--v-sectionPrimary-darken2)!important;caret-color:var(--v-sectionPrimary-darken2)!important}.v-application .sectionPrimary.darken-3{background-color:var(--v-sectionPrimary-darken3)!important;border-color:var(--v-sectionPrimary-darken3)!important}.v-application .sectionPrimary--text.text--darken-3{color:var(--v-sectionPrimary-darken3)!important;caret-color:var(--v-sectionPrimary-darken3)!important}.v-application .sectionPrimary.darken-4{background-color:var(--v-sectionPrimary-darken4)!important;border-color:var(--v-sectionPrimary-darken4)!important}.v-application .sectionPrimary--text.text--darken-4{color:var(--v-sectionPrimary-darken4)!important;caret-color:var(--v-sectionPrimary-darken4)!important}.v-application .sectionSecondary{background-color:var(--v-sectionSecondary-base)!important;border-color:var(--v-sectionSecondary-base)!important}.v-application .sectionSecondary--text{color:var(--v-sectionSecondary-base)!important;caret-color:var(--v-sectionSecondary-base)!important}.v-application .sectionSecondary.lighten-5{background-color:var(--v-sectionSecondary-lighten5)!important;border-color:var(--v-sectionSecondary-lighten5)!important}.v-application .sectionSecondary--text.text--lighten-5{color:var(--v-sectionSecondary-lighten5)!important;caret-color:var(--v-sectionSecondary-lighten5)!important}.v-application .sectionSecondary.lighten-4{background-color:var(--v-sectionSecondary-lighten4)!important;border-color:var(--v-sectionSecondary-lighten4)!important}.v-application .sectionSecondary--text.text--lighten-4{color:var(--v-sectionSecondary-lighten4)!important;caret-color:var(--v-sectionSecondary-lighten4)!important}.v-application .sectionSecondary.lighten-3{background-color:var(--v-sectionSecondary-lighten3)!important;border-color:var(--v-sectionSecondary-lighten3)!important}.v-application .sectionSecondary--text.text--lighten-3{color:var(--v-sectionSecondary-lighten3)!important;caret-color:var(--v-sectionSecondary-lighten3)!important}.v-application .sectionSecondary.lighten-2{background-color:var(--v-sectionSecondary-lighten2)!important;border-color:var(--v-sectionSecondary-lighten2)!important}.v-application .sectionSecondary--text.text--lighten-2{color:var(--v-sectionSecondary-lighten2)!important;caret-color:var(--v-sectionSecondary-lighten2)!important}.v-application .sectionSecondary.lighten-1{background-color:var(--v-sectionSecondary-lighten1)!important;border-color:var(--v-sectionSecondary-lighten1)!important}.v-application .sectionSecondary--text.text--lighten-1{color:var(--v-sectionSecondary-lighten1)!important;caret-color:var(--v-sectionSecondary-lighten1)!important}.v-application .sectionSecondary.darken-1{background-color:var(--v-sectionSecondary-darken1)!important;border-color:var(--v-sectionSecondary-darken1)!important}.v-application .sectionSecondary--text.text--darken-1{color:var(--v-sectionSecondary-darken1)!important;caret-color:var(--v-sectionSecondary-darken1)!important}.v-application .sectionSecondary.darken-2{background-color:var(--v-sectionSecondary-darken2)!important;border-color:var(--v-sectionSecondary-darken2)!important}.v-application .sectionSecondary--text.text--darken-2{color:var(--v-sectionSecondary-darken2)!important;caret-color:var(--v-sectionSecondary-darken2)!important}.v-application .sectionSecondary.darken-3{background-color:var(--v-sectionSecondary-darken3)!important;border-color:var(--v-sectionSecondary-darken3)!important}.v-application .sectionSecondary--text.text--darken-3{color:var(--v-sectionSecondary-darken3)!important;caret-color:var(--v-sectionSecondary-darken3)!important}.v-application .sectionSecondary.darken-4{background-color:var(--v-sectionSecondary-darken4)!important;border-color:var(--v-sectionSecondary-darken4)!important}.v-application .sectionSecondary--text.text--darken-4{color:var(--v-sectionSecondary-darken4)!important;caret-color:var(--v-sectionSecondary-darken4)!important}</style><link rel="preload" href="/_nuxt/5f42c53.js" as="script"><link rel="preload" href="/_nuxt/edeaba0.js" as="script"><link rel="preload" href="/_nuxt/css/eab4896.css" as="style"><link rel="preload" href="/_nuxt/3a50fca.js" as="script"><link rel="preload" href="/_nuxt/css/0ae499c.css" as="style"><link rel="preload" href="/_nuxt/aff6b7e.js" as="script"><link rel="preload" href="/_nuxt/72ace9c.js" as="script"><link rel="stylesheet" href="/_nuxt/css/eab4896.css"><link rel="stylesheet" href="/_nuxt/css/0ae499c.css"><link rel="preload" href="/_nuxt/static/1664267155/blog/a-complete-ml-pipeline-study-case-face-and-emotion-recognition/state.js" as="script"><link rel="preload" href="/_nuxt/static/1664267155/blog/a-complete-ml-pipeline-study-case-face-and-emotion-recognition/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1664267155/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div data-app="true" id="app-post" class="v-application v-application--is-ltr theme--light" data-v-000c4056><div class="v-application--wrap"><nav class="v-navigation-drawer v-navigation-drawer--close v-navigation-drawer--fixed v-navigation-drawer--is-mobile theme--light" style="height:100vh;top:0;transform:translateX(-100%);width:100%" data-v-5fc5aa13 data-v-000c4056><div class="v-navigation-drawer__content"><div class="container container--fluid" data-v-5fc5aa13><div class="row mr-3 justify-end" data-v-5fc5aa13><button type="button" class="v-btn v-btn--icon v-btn--round theme--light v-size--default" data-v-5fc5aa13><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-close theme--light" data-v-5fc5aa13></i></span></button></div> <div class="row" data-v-5fc5aa13><div class="col-sm-6 col-12" data-v-5fc5aa13><div class="container container--fluid fill-height" data-v-5fc5aa13><div class="row pt-6 align-center justify-center" data-v-5fc5aa13><div class="v-avatar outline-border" style="height:144px;min-width:144px;width:144px" data-v-3d5db6c9 data-v-5fc5aa13><img src="/_nuxt/img/9d8aa01.jpg" alt="avatar" data-v-3d5db6c9></div></div></div></div> <div class="col-sm-6 col-12" data-v-5fc5aa13><div class="v-list pt-6 mt-0 v-sheet theme--light rounded v-list--dense v-list--rounded" data-v-5fc5aa13><div role="listbox" class="v-item-group theme--light v-list-item-group" data-v-5fc5aa13><a href="/" tabindex="0" class="text-center primary--text v-list-item v-list-item--link theme--light" data-v-5fc5aa13><div class="row" data-v-5fc5aa13><div class="col col-12" data-v-5fc5aa13><div class="row justify-center" data-v-5fc5aa13><i aria-hidden="true" class="v-icon notranslate mr-4 primary--text mdi mdi-home theme--light" data-v-5fc5aa13></i>
                                        Home
                                    </div></div></div></a><a href="/resume" tabindex="0" class="text-center primary--text v-list-item v-list-item--link theme--light" data-v-5fc5aa13><div class="row" data-v-5fc5aa13><div class="col col-12" data-v-5fc5aa13><div class="row justify-center" data-v-5fc5aa13><i aria-hidden="true" class="v-icon notranslate mr-4 primary--text mdi mdi-timeline-text theme--light" data-v-5fc5aa13></i>
                                        Resume
                                    </div></div></div></a><a href="/projects" tabindex="0" class="text-center primary--text v-list-item v-list-item--link theme--light" data-v-5fc5aa13><div class="row" data-v-5fc5aa13><div class="col col-12" data-v-5fc5aa13><div class="row justify-center" data-v-5fc5aa13><i aria-hidden="true" class="v-icon notranslate mr-4 primary--text mdi mdi-briefcase-outline theme--light" data-v-5fc5aa13></i>
                                        Projects
                                    </div></div></div></a><a href="/github" tabindex="0" class="text-center primary--text v-list-item v-list-item--link theme--light" data-v-5fc5aa13><div class="row" data-v-5fc5aa13><div class="col col-12" data-v-5fc5aa13><div class="row justify-center" data-v-5fc5aa13><i aria-hidden="true" class="v-icon notranslate mr-4 primary--text mdi mdi-github theme--light" data-v-5fc5aa13></i>
                                        Github
                                    </div></div></div></a><a href="/blog" aria-current="page" tabindex="0" class="text-center primary--text v-item--active v-list-item--active v-list-item v-list-item--link theme--light" data-v-5fc5aa13><div class="row" data-v-5fc5aa13><div class="col col-12" data-v-5fc5aa13><div class="row justify-center" data-v-5fc5aa13><i aria-hidden="true" class="v-icon notranslate mr-4 primary--text mdi mdi-file-document-outline theme--light" data-v-5fc5aa13></i>
                                        Blog
                                    </div></div></div></a></div></div></div></div></div></div><div class="v-navigation-drawer__border"></div></nav> <header id="app-toolbar" class="v-sheet theme--dark v-toolbar v-toolbar--prominent v-app-bar v-app-bar--fade-img-on-scroll v-app-bar--elevate-on-scroll v-app-bar--fixed v-app-bar--hide-shadow v-app-bar--shrink-on-scroll primary" style="height:450px;font-size:1.5rem;margin-top:0;transform:translateY(0);left:0;right:0" data-v-a1e6582c data-v-000c4056><div class="v-toolbar__image" style="opacity:1"><div class="v-image v-responsive theme--dark" style="height:450px" data-v-a1e6582c><div class="v-image__image v-image__image--preload v-image__image--cover" style="background-image:linear-gradient(to top right,rgba(33,150,243,.9),rgba(33,150,243,.6));background-position:center center"></div><div class="v-responsive__content"></div></div></div><div class="v-toolbar__content" style="height:450px"> <button type="button" class="v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-a1e6582c><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-menu theme--dark" data-v-a1e6582c></i></span></button> <div class="v-toolbar__title pl-1 pr-3" data-v-a1e6582c><h3 data-v-a1e6582c>Post</h3></div> <div class="spacer" data-v-a1e6582c></div> <div class="row align-center justify-end" data-v-a1e6582c><!----> <button type="button" class="v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-a1e6582c><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate far fa-moon theme--dark" data-v-a1e6582c></i></span></button> <!----><!----><!----><!----><!----></div></div></header> <main class="v-main" style="padding-top:450px;padding-right:0;padding-bottom:0;padding-left:0" data-v-000c4056><div class="v-main__wrap"><div class="container container--fluid" data-v-8708675c data-v-8708675c data-v-8ad15b1a data-v-8ad15b1a data-v-000c4056><div class="container" data-v-8708675c data-v-8708675c><div class="row mt-8 justify-center" data-v-8708675c data-v-8708675c><div class="col-lg-10 col-xl-9 col" data-v-8708675c data-v-8708675c><div class="pa-0 py-2 mb-8 v-card v-sheet theme--light elevation-0 transparent" style="height:30px" data-v-8708675c><div class="v-card__title px-0 py-0 primary--text" data-v-8708675c>#computer-vision, #mlops
                    </div> <div class="v-card__text px-0 py-0 grey--text" data-v-8708675c>Written on: December 27, 2021
                    </div> <div class="v-card__text px-0 py-0 grey--text" data-v-8708675c>Latest update: December 27, 2021
                    </div></div> <article class="pt-12" data-v-8708675c><div class="nuxt-content" data-v-8708675c data-v-8708675c><h1 id="a-complete-ml-pipeline-study-case-face-and-emotion-recognition" data-v-8708675c data-v-8708675c><a href="#a-complete-ml-pipeline-study-case-face-and-emotion-recognition" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>A complete ML Pipeline study case: Face and Emotion recognition</h1>
<br data-v-8708675c data-v-8708675c>
<ul data-v-8708675c data-v-8708675c>
<li data-v-8708675c data-v-8708675c>Introduction</li>
<li data-v-8708675c data-v-8708675c>The study case: Face and Emotion recognition with a CNN</li>
<li data-v-8708675c data-v-8708675c>Do not forgive <strong data-v-8708675c data-v-8708675c>Optimization</strong></li>
<li data-v-8708675c data-v-8708675c>Prepare for production with <strong data-v-8708675c data-v-8708675c>ONNX</strong></li>
<li data-v-8708675c data-v-8708675c>Conclusions</li>
</ul>
<br data-v-8708675c data-v-8708675c>
<h2 id="introduction" data-v-8708675c data-v-8708675c><a href="#introduction" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>Introduction</h2>
<p data-v-8708675c data-v-8708675c>This post describes a project I made with my girlfriend, aiming to perform face and
emotion recognition through a Kinect sensor or a generic webcam.</p>
<p data-v-8708675c data-v-8708675c>The emotion supported are: <code data-v-8708675c data-v-8708675c>Happy</code>, <code data-v-8708675c data-v-8708675c>Sad</code>, <code data-v-8708675c data-v-8708675c>Disgust</code>, <code data-v-8708675c data-v-8708675c>Neutral</code>, <code data-v-8708675c data-v-8708675c>Fear</code>, <code data-v-8708675c data-v-8708675c>Angry</code>,
<code data-v-8708675c data-v-8708675c>Surprise</code>. The depth camera of the Kinect Sensor is used to carry out Depth
Segmentation and reduce face detection false positives. In addition, a confirmation
window is used to stabilize the model's predictions.</p>
<p data-v-8708675c data-v-8708675c>The model used is a CNN built from scratch and trained on FER 2013 Dataset. Then, an
optimization phase has been performed to obtain the best hyperparameters.
The following <a href="https://www.youtube.com/watch?v=kOJncJAVPng" data-v-8708675c data-v-8708675c>video</a> shows
the results of our work.</p>
<div class="blog-video-container" style="text-align:center" data-v-8708675c data-v-8708675c>
<iframe src="https://www.youtube.com/embed/kOJncJAVPng" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="blog-video" data-v-8708675c data-v-8708675c>
</iframe>
<p data-v-8708675c data-v-8708675c><br data-v-8708675c data-v-8708675c><br data-v-8708675c data-v-8708675c></p>
</div>
<h2 id="the-study-case-face-and-emotion-recognition-with-a-cnn" data-v-8708675c data-v-8708675c><a href="#the-study-case-face-and-emotion-recognition-with-a-cnn" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>The study case: Face and Emotion recognition with a CNN</h2>
<p data-v-8708675c data-v-8708675c>In this section, we describe the step we followed to train the face recognition and emotion
recognition models and use them on a video stream capture from a Camera / Kinect.</p>
<h3 id="face-detection-and-recognition-dataset-acquisition" data-v-8708675c data-v-8708675c><a href="#face-detection-and-recognition-dataset-acquisition" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>Face Detection and Recognition: Dataset acquisition</h3>
<p data-v-8708675c data-v-8708675c>To train face recognition we created a script that allowed us to collect images of a
person's faces. The script must be configured by passing as parameters the name and the
number of photos to be saved. The process uses opencv's face detector to automatically
extract faces and save them by labeling with the name entered.
This also allowed us to quickly review the saved photos and delete dirty data if any.
To have good recognition performance we used about 100 photos per person; results clearly
vary in different lighting conditions.</p>
<h3 id="face-detection-and-recognition-train-and-evaluation" data-v-8708675c data-v-8708675c><a href="#face-detection-and-recognition-train-and-evaluation" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>Face Detection and Recognition: Train and evaluation</h3>
<p data-v-8708675c data-v-8708675c>The training of opencv's LBPHFaceRecognizer is very quick. We trained it on two different
faces, but it's scalable on multiple faces.</p>
<p data-v-8708675c data-v-8708675c>For the inference phase we used the labels extracted from the LBPHFaceRecognizer of
opencv trained as described in the previous point to create <strong data-v-8708675c data-v-8708675c>Confirmation Windows</strong> for
each person and then isolate the emotions based on the detected face.
More details on the Confirmation Windows will be given later.</p>
<h3 id="emotions-recognition-data-exploration-and-processing" data-v-8708675c data-v-8708675c><a href="#emotions-recognition-data-exploration-and-processing" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>Emotions Recognition: Data Exploration and Processing</h3>
<p data-v-8708675c data-v-8708675c>We used FER2013 dataset. As a first step, we analyzed the dataset to verify its
distribution and check its content, displaying some images.</p>
<p data-v-8708675c data-v-8708675c>We noticed that it is a very difficult dataset, since it has 3 main issues:</p>
<ol data-v-8708675c data-v-8708675c>
<li data-v-8708675c data-v-8708675c>It is very <strong data-v-8708675c data-v-8708675c>unbalanced</strong>, as shown in Fig. 1;</li>
<li data-v-8708675c data-v-8708675c>The images it contains are <strong data-v-8708675c data-v-8708675c>dirty</strong> (some images are cartoons) or have noise (for
example writing or hands on the face). Refer to images contoured by red and blue rectangles in Fig. 2;</li>
<li data-v-8708675c data-v-8708675c>Some <strong data-v-8708675c data-v-8708675c>images could be misclassified</strong> (e.g. some emotion tagged as "fear" could be
classified as "surprise"). Refer to images contoured by green rectangles in Fig. 2.</li>
</ol>
<div style="text-align:center" data-v-8708675c data-v-8708675c>
<img src="/blog/a-complete-ml-pipeline-study-case-face-and-emotion-recognition/data-distribution.png" alt="data-distribution" width="80%" data-v-8708675c data-v-8708675c> 
<p data-v-8708675c data-v-8708675c><span style="font-size:12px" data-v-8708675c data-v-8708675c>Fig. 1. Distribution of the dataset. There is a predominance of "Happy" and "Neutral"</span>
<br data-v-8708675c data-v-8708675c></p>
</div>
<div style="text-align:center" data-v-8708675c data-v-8708675c>
<img src="/blog/a-complete-ml-pipeline-study-case-face-and-emotion-recognition/dataset-angry.png" alt="dataset-angry" width="80%" data-v-8708675c data-v-8708675c> 
<p data-v-8708675c data-v-8708675c><span style="font-size:12px" data-v-8708675c data-v-8708675c>Fig. 2. Some examples of images belonging to "Angry" emotion.
The red rectangle indicates an image taken from a cartoon. The blue rectangles are around images soiled by writing.
Finally, it is difficult to say if the woman in the green rectangle on the right is angry or shocked; the emotion of the man on the second row on the right could be considered also "Happy".</span>
<br data-v-8708675c data-v-8708675c></p>
</div>
<br data-v-8708675c data-v-8708675c>
<br data-v-8708675c data-v-8708675c>
<p data-v-8708675c data-v-8708675c>In fact, as mentioned in <a href="http://cs230.stanford.edu/projects_winter_2020/reports/32610274.pdf" rel="nofollow noopener noreferrer" target="_blank" data-v-8708675c data-v-8708675c>this paper (sec. III)</a>,
the human accuracy on this dataset is about 65%.</p>
<p data-v-8708675c data-v-8708675c>The dataset is already divided into train, validation and test and we made sure that the
three sets had the same distribution.
We then decided to merge the train and validation sets together, in order to be free
in choosing the percentage to be allocated to the validation set.</p>
<p data-v-8708675c data-v-8708675c>Finally, we decided not to use oversampling techniques and to use the as-is dataset,
to try to get the most out of the CNN network and the training process, without adding
new data.</p>
<h3 id="emotions-recognition-training-and-evaluation" data-v-8708675c data-v-8708675c><a href="#emotions-recognition-training-and-evaluation" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>Emotions Recognition: Training and Evaluation</h3>
<p data-v-8708675c data-v-8708675c>We used a CNN built from scratch, consisting of four convolution layers and two dense
layers. We verified that the model was sufficiently powerful and we managed overfitting
with regularization techniques such as l2 and dropout.</p>
<p data-v-8708675c data-v-8708675c>The dataset has been divided into 70% for training, 20% for validation and 10% for testing,
respectively. In the training phase, we used Keras' <code data-v-8708675c data-v-8708675c>ImageDataGenerator</code> utilities
to do some data augmentation and add zoomed and horizontally mirrored images.
This allowed us to increase the test performance a bit.</p>
<p data-v-8708675c data-v-8708675c>We have optimized the hyperparameters of the model through the use of <code data-v-8708675c data-v-8708675c>Optuna</code>;
details on hyperparameters and ranges will be given later.</p>
<p data-v-8708675c data-v-8708675c>In the evaluation phase, we plotted a normalized confusion matrix to understand the
performance of the model relative to each class. The results were what we expected: a
strong polarization towards the most populous classes and an average error spread across
all them. In fact, the performance mirrors the challenges of the dataset.</p>
<div style="text-align:center" data-v-8708675c data-v-8708675c>
<img src="/blog/a-complete-ml-pipeline-study-case-face-and-emotion-recognition/evaluate.png" alt="evaluate" width="80%" data-v-8708675c data-v-8708675c> 
<p data-v-8708675c data-v-8708675c><span style="font-size:12px" data-v-8708675c data-v-8708675c>Fig. 3. Confusion matrix after the optimization phase.</span>
<br data-v-8708675c data-v-8708675c></p>
</div>
<h3 id="improvements-for-real-use" data-v-8708675c data-v-8708675c><a href="#improvements-for-real-use" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>Improvements for real use</h3>
<p data-v-8708675c data-v-8708675c>Given the poor performance of the model and considered the fact that the images acquired
by a webcam may be "different" from those present in the dataset, we decided to add some
"improvements" for real use.
We first introduced a <strong data-v-8708675c data-v-8708675c>Confirmation Window</strong>, to stabilize the model predictions over
a higher frame number.
The confirmation window, implemented as a queue, collects the emotions of the last 20
frames and returns the value only if the dominant emotion is present in more than 60%
of the frames. If this condition is not satisfied, "Neutral" is returned, indicating
that the model is not fully convinced of the emotions collected in the last 20 frames.</p>
<p data-v-8708675c data-v-8708675c>A confirmation window is associated for each recognized person, so as not to mix
predictions related to different faces.
<strong data-v-8708675c data-v-8708675c>The benefit this implementation has brought is that the feeling that the model
is wrong has drastically reduced</strong>.</p>
<h2 id="building-freenect-and-the-python-wrapper" data-v-8708675c data-v-8708675c><a href="#building-freenect-and-the-python-wrapper" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>Building Freenect and the python wrapper</h2>
<p data-v-8708675c data-v-8708675c>The code can run also on a generic camera, but we used the Kinect to take advantage of
the depth sensor to decrease false positives.
We built its drivers on Mac OS, based on the Homebrew method described at the following
link: <a href="https://openkinect.org/wiki/Getting_Started#OS_X" rel="nofollow noopener noreferrer" target="_blank" data-v-8708675c data-v-8708675c>https://openkinect.org/wiki/Getting_Started#OS_X</a>.
With Homebrew you can easily install the Kinect v1 drivers.</p>
<p data-v-8708675c data-v-8708675c>Kinect's depth camera helped us to segment and filter objects based on depth.
This allows us to reduce the number of false positives of face detection.
Since there is no rejection threshold for face recognition, limiting false positives
also allows the predictions contained in the confirmation window to be "not dirty",
thus resulting in a reliable prediction.</p>
<br data-v-8708675c data-v-8708675c>
<h2 id="do-not-forgive-optimization" data-v-8708675c data-v-8708675c><a href="#do-not-forgive-optimization" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>Do not forgive Optimization</h2>
<p data-v-8708675c data-v-8708675c>After deciding that the chosen model had performances in line with what was expected,
we moved on to the optimization phase, to obtain better hyperparameters and therefore a
higher accuracy.
We used optuna, an optimization framework specifically designed for this task.</p>
<p data-v-8708675c data-v-8708675c>The hyperparameters we have optimized are:</p>
<div class="nuxt-content-highlight" data-v-8708675c data-v-8708675c><pre class="line-numbers language-python" data-v-8708675c data-v-8708675c><code data-v-8708675c data-v-8708675c>   <span class="token string" data-v-8708675c data-v-8708675c>'lr'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> learning rate<span class="token punctuation" data-v-8708675c data-v-8708675c>,</span> uniform distribution <span class="token keyword" data-v-8708675c data-v-8708675c>from</span> <span class="token number" data-v-8708675c data-v-8708675c>1e-5</span> to <span class="token number" data-v-8708675c data-v-8708675c>1e-1</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
   <span class="token string" data-v-8708675c data-v-8708675c>'decay'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> lr decay<span class="token punctuation" data-v-8708675c data-v-8708675c>,</span> uniform distribution <span class="token keyword" data-v-8708675c data-v-8708675c>from</span> <span class="token number" data-v-8708675c data-v-8708675c>1e-7</span> to <span class="token number" data-v-8708675c data-v-8708675c>1e-4</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
   <span class="token string" data-v-8708675c data-v-8708675c>'dropout'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> uniform distribution <span class="token keyword" data-v-8708675c data-v-8708675c>from</span> <span class="token number" data-v-8708675c data-v-8708675c>0.10</span> to <span class="token number" data-v-8708675c data-v-8708675c>0.50</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
   <span class="token string" data-v-8708675c data-v-8708675c>'l2'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> l2 regularization <span class="token keyword" data-v-8708675c data-v-8708675c>in</span> Conv2D layers<span class="token punctuation" data-v-8708675c data-v-8708675c>,</span> uniform distribution <span class="token keyword" data-v-8708675c data-v-8708675c>from</span> <span class="token number" data-v-8708675c data-v-8708675c>0.01</span> to <span class="token number" data-v-8708675c data-v-8708675c>0.05</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
   <span class="token string" data-v-8708675c data-v-8708675c>'kernel_size'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> <span class="token keyword" data-v-8708675c data-v-8708675c>for</span> Conv2D layers <span class="token keyword" data-v-8708675c data-v-8708675c>in</span> <span class="token builtin" data-v-8708675c data-v-8708675c>range</span> <span class="token punctuation" data-v-8708675c data-v-8708675c>[</span><span class="token number" data-v-8708675c data-v-8708675c>3</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span> <span class="token number" data-v-8708675c data-v-8708675c>5</span><span class="token punctuation" data-v-8708675c data-v-8708675c>]</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
   <span class="token string" data-v-8708675c data-v-8708675c>'batch_size'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> <span class="token keyword" data-v-8708675c data-v-8708675c>in</span> <span class="token builtin" data-v-8708675c data-v-8708675c>range</span> <span class="token punctuation" data-v-8708675c data-v-8708675c>[</span><span class="token number" data-v-8708675c data-v-8708675c>16</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span> <span class="token number" data-v-8708675c data-v-8708675c>32</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span> <span class="token number" data-v-8708675c data-v-8708675c>64</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span> <span class="token number" data-v-8708675c data-v-8708675c>128</span><span class="token punctuation" data-v-8708675c data-v-8708675c>]</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
</code></pre></div>
<p data-v-8708675c data-v-8708675c>The best hyperparameters, found in 50 iterations, are:</p>
<div class="nuxt-content-highlight" data-v-8708675c data-v-8708675c><pre class="line-numbers language-python" data-v-8708675c data-v-8708675c><code data-v-8708675c data-v-8708675c>   <span class="token string" data-v-8708675c data-v-8708675c>'lr'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> <span class="token number" data-v-8708675c data-v-8708675c>6.454516989719096e-05</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
   <span class="token string" data-v-8708675c data-v-8708675c>'decay'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> <span class="token number" data-v-8708675c data-v-8708675c>4.461966074951546e-05</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
   <span class="token string" data-v-8708675c data-v-8708675c>'dropout'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> <span class="token number" data-v-8708675c data-v-8708675c>0.3106791934814161</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
   <span class="token string" data-v-8708675c data-v-8708675c>'l2'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> <span class="token number" data-v-8708675c data-v-8708675c>0.04370766874155845</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
   <span class="token string" data-v-8708675c data-v-8708675c>'kernel_size'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> <span class="token number" data-v-8708675c data-v-8708675c>2</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
   <span class="token string" data-v-8708675c data-v-8708675c>'batch_size'</span><span class="token punctuation" data-v-8708675c data-v-8708675c>:</span> <span class="token number" data-v-8708675c data-v-8708675c>32</span><span class="token punctuation" data-v-8708675c data-v-8708675c>,</span>
</code></pre></div>
<p data-v-8708675c data-v-8708675c>with a test loss of: <code data-v-8708675c data-v-8708675c>1.0534</code>, and test accuracy of: <code data-v-8708675c data-v-8708675c>66.035%</code>.
The optimization phase added a few percentage points to the average accuracy; however we
can affirm that the perceived performances are much higher. The advice we give is
therefore not to forget the optimization phase; 4-5 percentage points are not many and do
not upset the performance of a poor-performing model, but they can still make a difference.</p>
<br data-v-8708675c data-v-8708675c>
<h2 id="prepare-for-production-with-onnx" data-v-8708675c data-v-8708675c><a href="#prepare-for-production-with-onnx" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>Prepare for production with ONNX</h2>
<p data-v-8708675c data-v-8708675c>To speed up the inference phase, we setup up the ONNX conversion and runtime tools.
After choosing the best hyperparameters for the emotion model, we trained it and got
an optimized Keras model.
So we converted it to a ONNX model.
Generally speaking, the ONNX model version is much faster than the Keras one.
This leads a less power consumption and a higher FPS for our video application.
On our machines (CPU based, no NVIDIA), the ONNX model is around 25x faster than keras
version.</p>
<p data-v-8708675c data-v-8708675c>These are the results:</p>
<div class="nuxt-content-highlight" data-v-8708675c data-v-8708675c><pre class="line-numbers language-text" data-v-8708675c data-v-8708675c><code data-v-8708675c data-v-8708675c>Keras predictor 100 times  -  Elapsed: 3.177694320678711; mean: 0.03177694320678711
ONNX predictor  100 times  -  Elapsed: 0.119029283523559; mean: 0.00119029283523559
Factor: 26.696.
</code></pre></div>
<div class="nuxt-content-highlight" data-v-8708675c data-v-8708675c><pre class="line-numbers language-text" data-v-8708675c data-v-8708675c><code data-v-8708675c data-v-8708675c>Keras predictor 10000 times  -  Elapsed: 317.5036771297455; mean: 0.03175036771297455
ONNX predictor  10000 times  -  Elapsed:  11.5271108150482; mean: 0.00115271108150482
Factor: 27.544.
</code></pre></div>
<br data-v-8708675c data-v-8708675c>
<h2 id="conclusions" data-v-8708675c data-v-8708675c><a href="#conclusions" aria-hidden="true" tabindex="-1" data-v-8708675c data-v-8708675c><span class="icon icon-link" data-v-8708675c data-v-8708675c></span></a>Conclusions</h2>
<p data-v-8708675c data-v-8708675c>Although the recognition of faces and emotions is not a new topic, it was interesting
to approach a challenging dataset, applying all the best practices that are used to
bring a solution into production.
The task was difficult mainly due to the implications of using a very unbalanced,
very heterogeneous dataset with few samples. We did a statistical analysis, but
decided not to oversample and treat the dataset as it was.
In order not to make things easier for us, we have decided not to do transfer
learning from a pre-trained model.</p>
<p data-v-8708675c data-v-8708675c>The optimization phase was fundamental to obtain
an accuracy of approximately 5% more. Although, accuracy is not perfectly indicative
of such an unbalanced dataset, the model's perceived performance after optimization
was much more satisfactory.
The use of <strong data-v-8708675c data-v-8708675c>confirmation windows also made a big difference</strong>; they are not a new
technique, but they help tremendously in correcting false positives and increasing
perceived performance.
Finally, the use of <strong data-v-8708675c data-v-8708675c>ONNX</strong> was important to achieve a performance boost on
the CPU and make the application usable in real time, reaching an average of 30 frames
processed per second on discrete computers.</p></div></article></div></div> <div class="client-only-placeholder" data-v-8708675c data-v-8708675c>loading...</div></div></div></div></main> <footer id="footer" class="v-footer v-sheet theme--dark v-footer--padless sectionPrimary" data-v-1a526349 data-v-000c4056><svg viewBox="0 0 120 28" class="footer-svg" data-v-1a526349><defs data-v-1a526349><path id="wave" d="M 0,10 C 30,10 30,15 60,15 90,15 90,10 120,10 150,10 150,15 180,15 210,15 210,10 240,10 v 28 h -240 z" data-v-1a526349></path></defs> <use id="wave3" xlink:href="#wave" x="0" y="-2" class="wave" data-v-1a526349></use> <use id="wave2" xlink:href="#wave" x="0" y="0" class="wave" data-v-1a526349></use> <use id="wave1" xlink:href="#wave" x="0" y="1" class="wave" data-v-1a526349></use></svg> <div class="text-center footer-content v-card v-sheet theme--dark elevation-0 rounded-0" style="width:100%" data-v-1a526349><div class="container pa-2" data-v-1a526349><div class="row mx-2 align-center" data-v-1a526349><div class="col" data-v-1a526349><hr role="separator" aria-orientation="horizontal" class="v-divider theme--dark" data-v-1a526349></div> <div class="col" data-v-1a526349><span class="overline" style="font-size:16px!important" data-v-1a526349>Stay in touch</span></div> <div class="col" data-v-1a526349><hr role="separator" aria-orientation="horizontal" class="v-divider theme--dark" data-v-1a526349></div></div></div> <div class="v-card__text py-2" data-v-1a526349><div class="row align-center justify-center" data-v-1a526349><div class="pa-2 col-md-6 col-12" data-v-1a526349><div class="container pa-2" data-v-1a526349><div class="row mt-4 align-center justify-center" data-v-1a526349><h2 data-v-1a526349>Social</h2></div> <div class="row my-2 py-2 align-center justify-center" data-v-1a526349><div class="pa-0 col col-auto" data-v-1a526349><a href="https://github.com/gioelecrispo" target="_blank" class="mx-2 v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-1a526349><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--dark" style="font-size:24px" data-v-1a526349></i></span></a></div><div class="pa-0 col col-auto" data-v-1a526349><a href="https://www.linkedin.com/in/gioele-crispo/" target="_blank" class="mx-2 v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-1a526349><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-linkedin theme--dark" style="font-size:24px" data-v-1a526349></i></span></a></div><div class="pa-0 col col-auto" data-v-1a526349><a href="https://www.facebook.com/gioelecrispo" target="_blank" class="mx-2 v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-1a526349><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-facebook theme--dark" style="font-size:24px" data-v-1a526349></i></span></a></div><div class="pa-0 col col-auto" data-v-1a526349><a href="https://www.instagram.com/gioelecrispo" target="_blank" class="mx-2 v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-1a526349><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-instagram theme--dark" style="font-size:24px" data-v-1a526349></i></span></a></div><div class="pa-0 col col-auto" data-v-1a526349><a href="https://www.youtube.com/channel/UCX38YLmygw3cfwljiNlBBQw" target="_blank" class="mx-2 v-btn v-btn--icon v-btn--round theme--dark v-size--default" data-v-1a526349><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-youtube theme--dark" style="font-size:24px" data-v-1a526349></i></span></a></div></div> <div class="row mt-4 pt-8 align-center justify-center" data-v-1a526349><h2 data-v-1a526349>Contacts</h2></div> <div class="row my-2 py-2 align-center justify-center" data-v-1a526349><i aria-hidden="true" class="v-icon notranslate ml-3 mr-1 mdi mdi-at theme--dark" data-v-1a526349></i> <span data-v-1a526349>crispogioele@gmail.com</span> <i aria-hidden="true" class="v-icon notranslate ml-3 mr-1 mdi mdi-skype theme--dark" data-v-1a526349></i> <span data-v-1a526349>gioele.crispo</span></div></div></div> <div class="pa-2 col-md-5 col-11" data-v-1a526349><div data-v-c6d6eba4 data-v-1a526349><form novalidate class="v-form" data-v-c6d6eba4><div class="v-input v-input--dense theme--dark v-text-field v-text-field--filled v-text-field--enclosed v-text-field--outlined" data-v-c6d6eba4><div class="v-input__control"><div class="v-input__slot"><fieldset aria-hidden="true"><legend style="width:0"><span class="notranslate">​</span></legend></fieldset><div class="v-text-field__slot"><label for="input-1116" class="v-label theme--dark" style="left:0;right:auto;position:absolute">Name</label><input required id="input-1116"></div></div><div class="v-text-field__details"><div class="v-messages theme--dark"><div class="v-messages__wrapper"></div></div></div></div></div> <div class="v-input v-input--dense theme--dark v-text-field v-text-field--filled v-text-field--enclosed v-text-field--outlined" data-v-c6d6eba4><div class="v-input__control"><div class="v-input__slot"><fieldset aria-hidden="true"><legend style="width:0"><span class="notranslate">​</span></legend></fieldset><div class="v-text-field__slot"><label for="input-1119" class="v-label theme--dark" style="left:0;right:auto;position:absolute">Your E-mail</label><input required id="input-1119"></div></div><div class="v-text-field__details"><div class="v-messages theme--dark"><div class="v-messages__wrapper"></div></div></div></div></div> <div class="v-input v-textarea v-input--dense theme--dark v-text-field v-text-field--filled v-text-field--enclosed v-text-field--outlined" data-v-c6d6eba4><div class="v-input__control"><div class="v-input__slot"><fieldset aria-hidden="true"><legend style="width:0"><span class="notranslate">​</span></legend></fieldset><div class="v-text-field__slot"><label for="input-1122" class="v-label theme--dark" style="left:0;right:auto;position:absolute">Your message for me</label><textarea required id="input-1122" rows="5"></textarea></div></div><div class="v-text-field__details"><div class="v-messages theme--dark"><div class="v-messages__wrapper"></div></div></div></div></div> <button type="button" disabled class="mr-4 v-btn v-btn--disabled v-btn--has-bg v-btn--rounded theme--dark v-size--default" data-v-c6d6eba4><span class="v-btn__content">
            Send Message
        </span></button></form> <div class="v-dialog__container" data-v-c6d6eba4><!----></div></div></div></div></div> <div class="v-card__text pt-6 pb-4" data-v-1a526349><blockquote class="subheader pa-0" data-v-1a526349>
                You can not discover new oceans if you do not have the courage to
                lose sight of the shore.
            </blockquote></div> <hr role="separator" aria-orientation="horizontal" class="v-divider theme--dark" data-v-1a526349> <div class="v-card__text py-4" data-v-1a526349><div class="row" data-v-1a526349><div class="py-1 col-sm-6 col-12" data-v-1a526349>2022 — <span class="subtitle-1" data-v-1a526349>Gioele Crispo</span></div> <div class="py-1 col-sm-6 col-12" data-v-1a526349><span data-v-52319016 data-v-1a526349><a class="mx-2 mb-1 terms" data-v-52319016><span data-v-52319016>Terms and policy</span> <i aria-hidden="true" class="v-icon notranslate ml-3 mdi mdi-information-outline theme--dark" style="font-size:20px" data-v-52319016></i></a> <div class="v-dialog__container" data-v-52319016><!----></div></span></div></div></div></div></footer></div></div></div></div><script defer src="/_nuxt/static/1664267155/blog/a-complete-ml-pipeline-study-case-face-and-emotion-recognition/state.js"></script><script src="/_nuxt/5f42c53.js" defer></script><script src="/_nuxt/72ace9c.js" defer></script><script src="/_nuxt/edeaba0.js" defer></script><script src="/_nuxt/3a50fca.js" defer></script><script src="/_nuxt/aff6b7e.js" defer></script>
  </body>
</html>
